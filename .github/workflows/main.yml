name: Main

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/main.yml'
      - 'projet.qmd'
      - 'syllabus.qmd'
      - 'slides/**'
      - 'tps/**'
      - 'examens/**'
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/main.yml'
      - 'syllabus.qmd'
      - 'slides/**'
      - 'tps/**'
      - 'examens/**'

concurrency: render

jobs:
  render:
    name: Render
    runs-on: ubuntu-latest
    env:
      LANG: en_US.UTF-8
      MARP_USER: 0:0
      OUTPUT_DIR: out
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Clean up
      run:  |
        rm -rf $OUTPUT_DIR
        mkdir $OUTPUT_DIR

    - name: Set up Quarto
      uses: quarto-dev/quarto-actions/setup@v2
      with:
        tinytex: true
    
    - name: Render Quarto documents
      uses: quarto-dev/quarto-actions/render@v2
      with:
        to: pdf
        path: .
    
    - name: Render PDF slides
      uses: docker://marpteam/marp-cli:v2.0.4
      with:
        args: -o out/slides --theme-set slides/themes/dauphine.css --html --allow-local-files --pdf -I slides

    - name: Commit
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        file_pattern: out/projet.pdf out/syllabus.pdf out/tps/*.pdf out/slides/*.pdf out/examens/*.pdf
        commit_message: '[auto] render PDFs'
